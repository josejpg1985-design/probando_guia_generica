<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Flashcard App</title>
    <link rel="stylesheet" href="/static/css/style.css?v=1.0.1">
    <script src="/static/js/theme.js" defer></script>
    <script src="/static/js/auth.js" defer></script>
    <script src="/static/js/main.js" defer></script>
</head>
<body>
    <div class="container dashboard-container">
        <h1>Bienvenido a tu Dashboard</h1>
        <p>Aquí gestionarás tus flashcards.</p>
        <div class="progress-container">
            <h3>Tu Progreso</h3>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
            <span id="progress-text">Cargando...</span>
        </div>
        <button id="logout-btn" class="btn">Cerrar Sesión</button>
        <a href="/archived" class="btn btn-primary">Ver Archivadas</a>

        <!-- Botón para abrir el modal de IA -->
        <button id="open-ai-modal-btn" class="btn-ai-modal">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2s2-.9 2-2V5c0-1.1-.9-2-2-2zM5 12c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2s2-.9 2-2v-2c0-1.1-.9-2-2-2zM19 12c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2s2-.9 2-2v-2c0-1.1-.9-2-2-2z"/></svg>
            <span>Analizar con IA</span>
        </button>
    </div>

    <!-- El Modal de Análisis de IA -->
    <div id="ai-analyzer-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-ai-modal-btn" class="modal-close-btn">&times;</button>
            <h2>Analizar Letras de Canciones</h2>
            <p>Pega la letra de una canción para encontrar vocabulario nuevo.</p>
            <div class="lyrics-analyzer-section">
                <textarea id="lyrics-input" placeholder="Pega aquí las letras de la canción..." rows="10"></textarea>
                <button id="analyze-lyrics-btn" class="btn btn-secondary">Extraer Nuevas Palabras</button>
                <div id="lyrics-analysis-results" class="results-container">
                    <!-- Results will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = verificarAutenticacion();
            if (!token) return; // La función ya se encarga de redirigir

            // 2. Verificar el token con el backend.
            fetch('/api/user_info', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    // Si el token es inválido o expiró, el backend dará error.
                    localStorage.removeItem('jwt_token');
                    throw new Error('Sesión inválida');
                }
                return response.json();
            })
            .then(data => {
                // 3. Si todo está bien, mostrar los datos del usuario.
                document.querySelector('h1').textContent = `Dashboard de ${data.email}`;

                // 3.1. Cargar y mostrar las categorías de estudio.
                fetch('/api/categories', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(res => res.json())
                .then(cat_data => {
                    if (cat_data.status === 'success' && cat_data.categories.length > 0) {
                        const container = document.querySelector('.dashboard-container');
                        
                        const categoryWrapper = document.createElement('div');
                        categoryWrapper.className = 'category-selector';
                        
                        const title = document.createElement('h2');
                        title.textContent = 'Elige una categoría para estudiar:';
                        categoryWrapper.appendChild(title);

                        const buttonGroup = document.createElement('div');
                        buttonGroup.className = 'button-group';

                        cat_data.categories.forEach(category => {
                            const categoryLink = document.createElement('a');
                            categoryLink.href = `/study/${encodeURIComponent(category)}`; 
                            categoryLink.className = 'btn btn-primary';
                            categoryLink.textContent = category;
                            buttonGroup.appendChild(categoryLink);
                        });

                        categoryWrapper.appendChild(buttonGroup);
                        container.appendChild(categoryWrapper);
                    }

                    // Fetch and display user progress
                    fetch('/api/user/progress', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                    .then(res => res.json())
                    .then(progressData => {
                        if (progressData.status === 'success') {
                            const { total_cards, archived_cards } = progressData.progress;
                            const progressFill = document.getElementById('progress-fill');
                            const progressText = document.getElementById('progress-text');

                            if (total_cards > 0) {
                                const percentage = (archived_cards / total_cards) * 100;
                                progressFill.style.width = `${percentage}%`;
                                progressText.textContent = `${archived_cards} / ${total_cards} tarjetas dominadas (${percentage.toFixed(1)}%)`;
                            } else {
                                progressFill.style.width = '0%';
                                progressText.textContent = 'Aún no tienes tarjetas.';
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error de autenticación:', error);
                window.location.href = '/';
            });

            // 4. Funcionalidad del botón de logout.
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('jwt_token');
                window.location.href = '/';
            });
        });
    </script>
</body>
</html>
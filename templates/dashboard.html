<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Flashcard App</title>
    <link rel="stylesheet" href="/static/css/style.css?v=1.0.1">
    <script src="/static/js/theme.js" defer></script>
    <script src="/static/js/auth.js" defer></script>
    <script src="/static/js/main.js" defer></script>
</head>
<body>
    <div class="container dashboard-container">
        <h1>Dashboard</h1>
        <div class="profile-header">
            <h2 id="user-display-name"></h2>
            <button id="edit-alias-btn" class="btn-icon-text" title="Editar alias">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            </button>
        </div>
        <div id="edit-alias-form" class="button-group" style="display: none;">
            <input type="text" id="alias-input" class="form-control" placeholder="Nuevo alias">
            <button id="save-alias-btn" class="btn btn-primary">Guardar</button>
            <button id="cancel-alias-btn" class="btn">Cancelar</button>
        </div>
        <p>Aquí gestionarás tus flashcards.</p>
        <div class="progress-container">
            <h3>Tu Progreso</h3>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
            <span id="progress-text">Cargando...</span>
        </div>
        <div class="button-group">
            <button id="logout-btn" class="btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span>Cerrar Sesión</span>
            </button>
            <a href="/archived" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
                <span>Ver Archivadas</span>
            </a>
            <a href="/espanol" class="btn btn-secondary">ES</a>
        </div>

        <!-- Botón para abrir el modal de IA -->
        <button id="open-ai-modal-btn" class="btn-ai-modal">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2s2-.9 2-2V5c0-1.1-.9-2-2-2zM5 12c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2s2-.9 2-2v-2c0-1.1-.9-2-2-2zM19 12c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2s2-.9 2-2v-2c0-1.1-.9-2-2-2z"/></svg>
            <span>Analizar con IA</span>
        </button>
    </div>

    <!-- El Modal de Análisis de IA -->
    <div id="ai-analyzer-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-ai-modal-btn" class="modal-close-btn">&times;</button>
            <h2>Analizar Letras de Canciones</h2>
            <p>Pega la letra de una canción para encontrar vocabulario nuevo.</p>
            <div class="lyrics-analyzer-section">
                <textarea id="lyrics-input" placeholder="Pega aquí las letras de la canción..." rows="10"></textarea>
                <button id="analyze-lyrics-btn" class="btn btn-secondary">Extraer Nuevas Palabras</button>
                <div id="lyrics-analysis-results" class="results-container">
                    <!-- Results will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = verificarAutenticacion();
            if (!token) return; // La función ya se encarga de redirigir

            // 2. Verificar el token con el backend.
            fetch('/api/user_info', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    // Si el token es inválido o expiró, el backend dará error.
                    localStorage.removeItem('jwt_token');
                    throw new Error('Sesión inválida');
                }
                return response.json();
            })
            .then(data => {
                // 3. Si todo está bien, mostrar los datos del usuario.
                const userDisplayName = document.getElementById('user-display-name');
                const updateDisplayName = () => {
                    const displayName = data.alias || data.email;
                    userDisplayName.textContent = displayName;
                };
                updateDisplayName();

                // --- Lógica para editar el alias ---
                const editAliasBtn = document.getElementById('edit-alias-btn');
                const editAliasForm = document.getElementById('edit-alias-form');
                const aliasInput = document.getElementById('alias-input');
                const saveAliasBtn = document.getElementById('save-alias-btn');
                const cancelAliasBtn = document.getElementById('cancel-alias-btn');

                editAliasBtn.addEventListener('click', () => {
                    editAliasForm.style.display = 'flex';
                    aliasInput.value = data.alias || '';
                    aliasInput.focus();
                });

                cancelAliasBtn.addEventListener('click', () => {
                    editAliasForm.style.display = 'none';
                });

                saveAliasBtn.addEventListener('click', async () => {
                    const newAlias = aliasInput.value.trim();
                    if (!newAlias) {
                        // Maybe show a small error message here
                        return;
                    }

                    try {
                        const response = await fetch('/api/user/alias', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ alias: newAlias })
                        });

                        const result = await response.json();

                        if (response.ok && result.status === 'success') {
                            data.alias = newAlias; // Update local data
                            updateDisplayName();
                            editAliasForm.style.display = 'none';
                        } else {
                            alert(`Error: ${result.message}`);
                        }
                    } catch (error) {
                        alert('Error de red al guardar el alias.');
                    }
                });

                // 3.1. Cargar y mostrar las categorías de estudio.
                fetch('/api/categories', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(res => res.json())
                .then(cat_data => {
                    if (cat_data.status === 'success' && cat_data.categories.length > 0) {
                        const container = document.querySelector('.dashboard-container');
                        
                        const categoryWrapper = document.createElement('div');
                        categoryWrapper.className = 'category-selector';
                        
                        const title = document.createElement('h2');
                        title.textContent = 'Elige una categoría para estudiar:';
                        categoryWrapper.appendChild(title);

                        const buttonGroup = document.createElement('div');
                        buttonGroup.className = 'button-group';

                        cat_data.categories.forEach(category => {
                            const categoryLink = document.createElement('a');
                            categoryLink.href = `/study/${encodeURIComponent(category)}`; 
                            categoryLink.className = 'btn btn-primary';
                            categoryLink.textContent = category;
                            buttonGroup.appendChild(categoryLink);
                        });

                        categoryWrapper.appendChild(buttonGroup);
                        container.appendChild(categoryWrapper);
                    }

                    // Fetch and display user progress
                    fetch('/api/user/progress', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                    .then(res => res.json())
                    .then(progressData => {
                        if (progressData.status === 'success') {
                            const { total_cards, archived_cards } = progressData.progress;
                            const progressFill = document.getElementById('progress-fill');
                            const progressText = document.getElementById('progress-text');

                            if (total_cards > 0) {
                                const percentage = (archived_cards / total_cards) * 100;
                                progressFill.style.width = `${percentage}%`;
                                progressText.textContent = `${archived_cards} / ${total_cards} tarjetas dominadas (${percentage.toFixed(1)}%)`;
                            } else {
                                progressFill.style.width = '0%';
                                progressText.textContent = 'Aún no tienes tarjetas.';
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error de autenticación:', error);
                window.location.href = '/';
            });

            // 4. Funcionalidad del botón de logout.
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('jwt_token');
                window.location.href = '/';
            });
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudiando: {{ category }}</title>
    <link rel="stylesheet" href="/static/css/style.css?v=1.0.1">
    <script src="/static/js/theme.js" defer></script>
    <script src="/static/js/auth.js" defer></script>
</head>
<body>
    <div class="container study-container">
        <a href="/dashboard" class="home-link" aria-label="Volver al Dashboard" title="Volver al Dashboard">üè†</a>
        <div class="study-progress" id="study-progress"></div>
        <h1>Estudiando: <span id="category-title">{{ category }}</span></h1>

        <div class="search-container" style="margin-bottom: 1rem;">
            <input type="search" id="study-search-input" class="form-control" placeholder="Buscar en esta categor√≠a...">
        </div>

        <div class="flashcard-area">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front" id="card-front">
                    <!-- Content will be injected by JS -->
                </div>
                <div class="card-face card-back" id="card-back">
                    <!-- Content will be injected by JS -->
                </div>
            </div>
        </div>

        <div class="navigation">
            <!-- El bot√≥n "Siguiente" se elimina ya que la calificaci√≥n avanza la tarjeta -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = verificarAutenticacion();
            if (!token) return;

            // --- Elementos del DOM ---
            const category = "{{ category }}";
            const flashcardEl = document.getElementById('flashcard');
            const cardFrontEl = document.getElementById('card-front');
            const cardBackEl = document.getElementById('card-back');
            const studyProgressEl = document.getElementById('study-progress');
            const searchInput = document.getElementById('study-search-input');

            // --- Estado de la aplicaci√≥n ---
            let flashcards = [];
            let currentCardIndex = 0;
            let debounceTimeout;

            // --- Funciones de L√≥gica ---
            function highlightTerm(text, term) {
                if (!text || !term) return text;
                try {
                    const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\            // --- Funciones de L√≥gica ---');
                    const regex = new RegExp(`(\\b${escapedTerm}\\b)`, 'gi');
                    return text.replace(regex, '<strong>$1</strong>');
                } catch (e) {
                    console.error("Error during highlight:", e);
                    return text;
                }
            }
            function highlightTerm(text, term) {
                if (!text || !term) return text;
                try {
                    const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\// --- Funciones de L√≥gica ---');
                    const regex = new RegExp(`(\\b${escapedTerm}\\b)`, 'gi');
                    return text.replace(regex, '<strong>$1</strong>');
                } catch (e) {
                    console.error("Error during highlight:", e);
                    return text;
                }
            }
            function updateStudyProgress() {
                fetch('/api/user/progress', { headers: { 'Authorization': `Bearer ${token}` } })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') return;
                    const { total_cards, archived_cards } = data.progress;
                    if (total_cards > 0) {
                        const percentage = (archived_cards / total_cards) * 100;
                        studyProgressEl.textContent = `Progreso: ${percentage.toFixed(1)}%`;
                    } else {
                        studyProgressEl.textContent = 'Progreso: 0%';
                    }
                });
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function fetchAndRenderCards(searchTerm = '') {
                const url = `/api/flashcards/${category}?search=${encodeURIComponent(searchTerm)}`;
                fetch(url, { headers: { 'Authorization': `Bearer ${token}` } })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            flashcards = data.flashcards;
                            currentCardIndex = 0;
                            if (flashcards.length > 0) {
                                // Solo barajar si no es una b√∫squeda, para mantener el orden
                                if (searchTerm === '') {
                                    shuffleArray(flashcards);
                                }
                                showCard(currentCardIndex);
                            } else {
                                // Mensaje diferente si no hay resultados de b√∫squeda
                                const message = searchTerm 
                                    ? 'No se encontraron tarjetas con ese t√©rmino de b√∫squeda.'
                                    : '¬°Felicidades! Has completado todas las tarjetas de esta categor√≠a.';
                                showEmptyState(message);
                            }
                        } else {
                            showEmptyState(`Error: ${data.message}`);
                        }
                    }).catch(err => showEmptyState('Error de red al cargar las tarjetas.'));
            }

            function showEmptyState(message) {
                flashcardEl.classList.remove('is-flipped');
                cardFrontEl.innerHTML = `<p>${message}</p>`;
                cardBackEl.innerHTML = '';
                document.querySelector('.navigation').innerHTML = '';
            }

            function showCard(index) {
                flashcardEl.classList.remove('is-flipped');
                if (flashcards.length === 0) return; // Deber√≠a ser manejado por showEmptyState
                
                const card = flashcards[index];
                cardFrontEl.innerHTML = `
                    <span class="flip-counter" title="Veces girada">üîÑ ${card.flip_count || 0}</span>
                    <p>${card.front_content}</p>
                `;
                
                let backHtml = `
                    <div class="card-content-display"><p>${card.back_content}</p></div>
                    <div class="top-icons-container">
                `;
                if (card.example_en && card.example_es) {
                    backHtml += `
                        <div class="example-icon-container">
                            <span class="example-icon">‚ÑπÔ∏è</span>
                            <div class="tooltip">
                                <strong>EN:</strong> ${card.example_en}<br>
                                <strong>ES:</strong> ${card.example_es}
                            </div>
                        </div>
                    `;
                }
                backHtml += `
                        <div class="edit-icon-container">
                            <span class="edit-icon" data-card-id="${card.id}">‚úèÔ∏è</span>
                            <div class="tooltip">Editar tarjeta</div>
                        </div>
                        <div class="archive-icon-container">
                            <span class="archive-icon" data-card-id="${card.id}">üóÑÔ∏è</span>
                            <div class="tooltip">Archivar tarjeta</div>
                        </div>
                    </div>
                    <div class="rating-buttons">
                        <button class="btn btn-rating" data-rating="easy">F√°cil (${card.easy_count || 0})</button>
                        <button class="btn btn-rating" data-rating="hard">Dif√≠cil (${card.hard_count || 0})</button>
                    </div>
                `;
                cardBackEl.innerHTML = backHtml;
            }

            function goNextCard() {
                flashcardEl.classList.remove('is-flipped');
                setTimeout(() => {
                    if (flashcards.length <= 1) { // Si solo queda una o ninguna, mostramos mensaje de fin
                        fetchAndRenderCards(searchInput.value); // Recargar para mostrar mensaje de completado
                        return;
                    }
                    flashcards.splice(currentCardIndex, 1); // Eliminar la tarjeta actual de la lista
                    if (currentCardIndex >= flashcards.length) {
                        currentCardIndex = 0; // Volver al inicio si era la √∫ltima
                    }
                    showCard(currentCardIndex);
                }, 300);
            }

            function enterEditMode() {
                const card = flashcards[currentCardIndex];
                const displayDiv = cardBackEl.querySelector('.card-content-display');
                displayDiv.style.display = 'none';

                let editHtml = `
                    <div class="edit-mode-container">
                        <textarea id="edit-textarea" class="edit-textarea">${card.back_content}</textarea>
                        <div class="edit-controls">
                            <button class="btn btn-primary save-btn">Guardar</button>
                            <button class="btn cancel-btn">Cancelar</button>
                            <button class="btn btn-danger delete-btn">Eliminar</button>
                        </div>
                    </div>
                `;
                cardBackEl.insertAdjacentHTML('beforeend', editHtml);
                cardBackEl.querySelector('.rating-buttons').style.display = 'none';
                cardBackEl.querySelector('.top-icons-container').style.display = 'none';
            }

            function exitEditMode(newContent = null) {
                const card = flashcards[currentCardIndex];
                if (newContent !== null) {
                    card.back_content = newContent;
                    flashcards[currentCardIndex].back_content = newContent;
                }
                
                const editContainer = cardBackEl.querySelector('.edit-mode-container');
                if(editContainer) editContainer.remove();
                
                const displayDiv = cardBackEl.querySelector('.card-content-display');
                if(displayDiv) {
                    displayDiv.innerHTML = `<p>${card.back_content}</p>`;
                    displayDiv.style.display = 'block';
                }

                cardBackEl.querySelector('.rating-buttons').style.display = 'flex';
                cardBackEl.querySelector('.top-icons-container').style.display = 'flex';
            }

            // --- Inicializaci√≥n y Event Listeners ---
            updateStudyProgress();
            fetchAndRenderCards(); // Carga inicial de tarjetas

            searchInput.addEventListener('input', (event) => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    fetchAndRenderCards(event.target.value);
                }, 300);
            });

            flashcardEl.addEventListener('click', (event) => {
                const isIcon = event.target.closest('.top-icons-container, .rating-buttons, .edit-mode-container');
                if (!flashcardEl.classList.contains('is-flipped') && !isIcon && flashcards.length > 0) {
                    const card = flashcards[currentCardIndex];
                    fetch(`/api/flashcards/${card.id}/flip`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).catch(err => console.error('Error al incrementar el contador:', err));
                    flashcardEl.classList.add('is-flipped');
                }
            });

            cardBackEl.addEventListener('click', async (event) => {
                const currentCard = flashcards[currentCardIndex];
                if (!currentCard) return;

                if (event.target.classList.contains('btn-rating')) {
                    const ratingText = event.target.dataset.rating;
                    const ratingValue = { 'easy': 3, 'hard': 1 }[ratingText];
                    fetch('/api/flashcards/rate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ card_id: currentCard.id, rating: ratingValue })
                    }).then(res => res.json()).then(data => {
                        if (data.status === 'success') {
                            goNextCard();
                            updateStudyProgress();
                        } else {
                            alert('Error al calificar: ' + data.message);
                        }
                    }).catch(err => alert('Error de red al calificar.'));
                }

                if (event.target.classList.contains('archive-icon')) {
                    fetch('/api/flashcards/archive', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ card_id: currentCard.id })
                    }).then(res => res.json()).then(data => {
                        if (data.status === 'success') {
                            goNextCard();
                            updateStudyProgress();
                        } else alert('Error al archivar: ' + data.message);
                    }).catch(err => alert('Error de red al archivar.'));
                }

                if (event.target.classList.contains('edit-icon')) enterEditMode();
                if (event.target.classList.contains('cancel-btn')) exitEditMode();
                
                if (event.target.classList.contains('save-btn')) {
                    const newContent = document.getElementById('edit-textarea').value;
                    fetch(`/api/flashcards/${currentCard.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ back_content: newContent })
                    }).then(res => res.json()).then(data => {
                        if (data.status === 'success') exitEditMode(newContent);
                        else alert('Error al guardar: ' + data.message);
                    }).catch(err => alert('Error de red al guardar.'));
                }

                if (event.target.classList.contains('delete-btn')) {
                    if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarjeta permanentemente?')) {
                        if (confirm('Esta acci√≥n no se puede deshacer. ¬øConfirmas la eliminaci√≥n?')) {
                            fetch(`/api/flashcards/${currentCard.id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            }).then(res => res.json()).then(data => {
                                if (data.status === 'success') {
                                    goNextCard();
                                } else alert('Error al eliminar: ' + data.message);
                            }).catch(err => alert('Error de red al eliminar.'));
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>